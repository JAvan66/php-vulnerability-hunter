using Components.MicroScript.Parser;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;

namespace Components.MicroScript.Interpreter
{
    public class OperatorHelper
    {
        private Func<MicroScriptObject, MicroScriptObject> _callInitFunction;

        public OperatorHelper(Func<MicroScriptObject, MicroScriptObject> callInitFunction)
        {
            _callInitFunction = callInitFunction;
        }

        public MicroScriptObject Add(MicroScriptObject x, MicroScriptObject y)
        {
            if (x.Value is decimal && y.Value is Decimal)
            {
                return ValueHelper.Wrap((decimal)x.Value + (decimal)y.Value);
            }            
            else
            {
                return _callInitFunction(ValueHelper.Wrap(Convert.ToString(x.Value) + Convert.ToString(y.Value)));
            }
        }

        public MicroScriptObject Subtract(MicroScriptObject x, MicroScriptObject y)
        {
            return ValueHelper.Wrap(((decimal)x.Value) - (decimal)y.Value);
        }

        public MicroScriptObject Multiply(MicroScriptObject x, MicroScriptObject y)
        {
            object val;
            if (x.Value is Decimal)
            {
                val = ((decimal)x.Value) * (decimal)y.Value;
            }
            else if (x.Value is string)
            {
                var s = x.Value as string;
                var sb = new StringBuilder();

                for (int i = 0; i < (decimal)y.Value; i++)
                {
                    sb.Append(s);
                }

                return _callInitFunction(ValueHelper.Wrap(sb.ToString()));

                //val = sb.ToString();
            }
            else
            {
                throw new MicroScriptRuntimeException("Could not multiply type");
            }

            return ValueHelper.Wrap(val);
        }

        public MicroScriptObject Divide(MicroScriptObject x, MicroScriptObject y)
        {
            return ValueHelper.Wrap(((decimal)x.Value) / (decimal)y.Value);
        }
    }
}
