using System;
using System.Collections.Generic;
using System.Linq;
using System.Reflection;
using Components.MicroScript.Interpreter;

namespace Components.MicroScript.Library
{
    public class MicroScriptLoader
    {
        public void LoadLibrary<TLibrary>(MicroScriptObject scope)
        {
            var methods = typeof(TLibrary)
                .GetMethods(
                    BindingFlags.Static | 
                    BindingFlags.NonPublic |
                    BindingFlags.Public)
                .Select (x => new
                {
                    Method = x,
                    Attributes = x
                        .GetCustomAttributes (true)
                        .Where (y => y is MicroScriptInteropFunctionAttribute)
                        .Cast<MicroScriptInteropFunctionAttribute>()
                        .ToArray ()
                })
                .SelectMany (x => x.Attributes.Select (y => Tuple.Create (y.Name, x.Method)));

            foreach (var method in methods) 
            {
                SetMember(scope, method.Item1, new MicroScriptInteropFunction(method.Item2));
            }
        }

        public void SetMember(MicroScriptObject scope, string path, object value)
        {
            var members = path.Split('.');
            
            var currentObj = scope;
            
            foreach (var m in members)
            {
                if (!currentObj.ContainsKey(m))
                {
                    currentObj.Add(m, new MicroScriptObject());
                }
                
                currentObj = currentObj[m];
            }
            
            currentObj.Value = value;
        }
    }
}

