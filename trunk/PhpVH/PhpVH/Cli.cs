using System;
using System.IO;
using System.Reflection;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Windows.Forms;
using System.Diagnostics;
using PhpVH.ScanPlugins;
using System.Text.RegularExpressions;

namespace PhpVH
{
    public class Cli
    {
        public static void ResetColors()
        {
            Console.ResetColor();
        }

        public static void DisplayAppInfo()
        {
            string appName = "PHP Vulnerability Hunter";
            Console.ForegroundColor = ConsoleColor.White;
            Console.BackgroundColor = ConsoleColor.DarkGreen;
            TraceHelper.WriteLineFormat("[+ {0} {1} +]\r\n",
                appName,
                Assembly.GetExecutingAssembly().GetName().Version.ToString());
            Console.ResetColor();
            TraceHelper.WriteLineFormat("Copyright (C) {0} John Leitch http://www.autosectools.com\r\n",
                DateTime.Now.Year);
            
        }

        public static void DisplayInstructions()
        {
            TraceHelper.WriteLineFormat(
@"== Before You Start

For PHP Vulnerability Hunter to successfully run the following 
conditions must be met: 

1) PHP Vulnerability Hunter must be run as administrator 

2) The targeted web application must not be accessed while PHP 
Vulnerability Hunter is running 

3) Only one instance of PHP Vulnerability Hunter per webroot can
be running at any time 

                 
== Arguments

phpvh [-s] [-p] [-m] [-t] [-c] [-c2] [-d] [-v] [-b] [-h] [-r]
    [-dump] [-log] [-static] webroot apps

webroot       Absolute web root (required)

apps          Application paths (comma delimited, required)
              Use * to scan every application in the webroot

-s            Server (default localhost)

-p            Port (default 80)

-m            Scan modes (default CFLPSXRI)
              C - Arbitrary Command Execution 
              F - Arbitrary File Write/Change/Rename/Delete 
              L - Local File Inclusion/Arbitrary File Read 
              P - Arbitrary PHP Execution 
              S - SQL Injection 
              D - Dynamic Function Call/Class Instantiation
              X - Reflected Cross-site Scripting (XSS)
              R - Open Redirect
              I - Full Path Disclosure

-t timeout    Timeout in milliseconds (default 60000)

-c            Code coverage report

-c2           High accuracy code coverage report 
              WARNING: may cause slowdown and timeouts 

-d            Scan overview report

-v            Open vulnerability report viewer

-b            Beep on vulnerability alert

-h            Hook superglobals
              Alternative to the superglobal override class
              Use to test different code paths or if 
              superglobal override causes errors, although  
              hooking frequently causes errors itself

-r            Repair mode
              Use to repair an application if PHP 
              Vulnerability Hunter crashes during a scan

-dump         Dump all http messages

-log          Log console output

-static       Static analysis only

== Examples

phpvh c:\xampp\htdocs MyApp 
Runs all scans on app located at c:\xampp\htdocs\MyApp

phpvh -m CX c:\xampp\htdocs MyApp1,MyApp2 
Runs Command Execution and Reflected XSS scans on applications 
located at c:\xampp\htdocs\MyApp1 and c:\xampp\htdocs\MyApp2

phpvh c:\xampp\htdocs * 
Runs all scans on every folder in the webroot");


        }

        public static void DisplayCriticalMessage(string Message, params object[] Arguments)
        {
            TraceHelper.WriteFormat(Message, Arguments);            
        }

        public static void DisplayCriticalMessageAndExit(string Message, params object[] Arguments)
        {
            DisplayCriticalMessage(Message, Arguments);

            Environment.Exit(0);
        }

        public static void DisplayScanPlugin(ScanPluginBase Plugin)
        {
            Console.ForegroundColor = ConsoleColor.Cyan;
            TraceHelper.WriteLineFormat(Plugin.ToString());
            Console.ForegroundColor = ConsoleColor.White;
        }

        public static void DisplayResourcePath(string Path)
        {
            Console.ForegroundColor = ConsoleColor.White;
            TraceHelper.WriteLineFormat(Path);
        }

        public static void DisplayResponse(HttpResponse Response, 
            int Mode, int InputCount, long Milliseconds)
        {
            var resp = !string.IsNullOrEmpty(Response.Header) ?
                    Response.Header.Split('\r', '\n')[0] :
                    "[No Header]";
            Console.ForegroundColor = ConsoleColor.Gray;
            TraceHelper.WriteFormat("{{Mode: {0}, Input Count: ", Mode);

            if (InputCount >= 20)
                Console.ForegroundColor = ConsoleColor.Red;
            else if (InputCount > 0)
                Console.ForegroundColor = ConsoleColor.Yellow;

            TraceHelper.WriteFormat("{0}", InputCount);

            ResetColors();

            Trace.Write("} -> ");
            
            if (Regex.IsMatch(resp, @"\s[45]\d{2}($|[^\d])"))
                Console.ForegroundColor = ConsoleColor.Red;
            else if (Regex.IsMatch(resp, @"\s2\d{2}($|[^\d])"))
                Console.ForegroundColor = ConsoleColor.Green;
            else
                Console.ForegroundColor = ConsoleColor.DarkCyan;
            Trace.Write(resp);
            ResetColors();

            Trace.Write(" (");

            if (Milliseconds > 20000)
                Console.ForegroundColor = ConsoleColor.Red;
            else if (Milliseconds > 10000)
                Console.ForegroundColor = ConsoleColor.Yellow;
            else
                Console.ForegroundColor = ConsoleColor.Green;

            Trace.Write(string.Format("{0:N0}ms", Milliseconds));

            ResetColors();

            Trace.WriteLine(")");
        }

        public static void DisplayResponseError(string Response)
        {
            TraceHelper.WriteLineFormat("Error reading response");
            //TraceHelper.WriteLineFormat(Response);
        }

        public static void DisplayPhaseName(string name)
        {
            Console.ForegroundColor = ConsoleColor.Blue;
            Console.BackgroundColor = ConsoleColor.White;
            Trace.Write(name);
            Console.ResetColor();
            TraceHelper.WriteLine();
            
            Console.ResetColor();
        }

        public static void DisplayAlert(ScanAlert Alert)
        {
            //Alert.Trace.Request

            if (Alert.AlertType == ScanAlertOptions.Warning)
            {
                Console.ForegroundColor = ConsoleColor.Yellow;
                Trace.Write("Warning");
            }
            else
            {
                Console.ForegroundColor = ConsoleColor.Red;
                Trace.Write("Potential Vulnerability");
            }

            TraceHelper.WriteLineFormat(": {0}", Alert.AlertName);

            ResetColors();
        }

        public static void DisplayError(string Error)
        {
            Console.ForegroundColor = ConsoleColor.Red;

            TraceHelper.WriteLineFormat(Error);

            Console.ForegroundColor = ConsoleColor.White;
        }

        public static void DisplayAppPath(string Path)
        {
            Console.ForegroundColor = ConsoleColor.Cyan;
            TraceHelper.WriteLineFormat("Scanning " + Path);
            Console.ForegroundColor = ConsoleColor.White;
        }

        public static void DisplayDiscoveredUrl(string url)
        {
            TraceHelper.WriteFormat("[");
            Console.ForegroundColor = ConsoleColor.Green;
            TraceHelper.WriteFormat("+");
            Console.ResetColor();
            TraceHelper.WriteLineFormat("] {0}", url);            
        }

        public static void DisplayScrapedUrl(string url, IEnumerable<FormTag> forms)
        {
            var count = forms.SelectMany(x => x.Inputs).Count();
            TraceHelper.WriteFormat("{0} -> ", url);

            if (count != 0)
                Console.ForegroundColor = ConsoleColor.Yellow;

            TraceHelper.WriteLineFormat("{0}", count);

            Console.ResetColor();

        }

        public static void RunAssistant()
        {
            var file = @".\hr";

            var showDialog = 
                !Environment.GetCommandLineArgs().Any(x => x == "-l") &&
                !File.Exists(file);

            File.Create(file).Close();

            if (showDialog)
            {
                if (MessageBox.Show(@"It seems this is the first time PHP " +
                    "Vulnerability Hunter has been run on this system. " + 
                    "Would you like to use the launcher instead of the command line " + 
                    "interface?", "Run Launcher",
                    MessageBoxButtons.YesNo) == DialogResult.Yes)
                {
                    var guiFile = "phpvh-gui.exe";

                    if (!File.Exists(guiFile))
                    {
                        Cli.DisplayError(string.Format("Could not find launcher {0}", guiFile));
                        Environment.Exit(6);
                    }

                    Process.Start(guiFile);
                    Environment.Exit(0);
                }
            }

            
        }
    }
}
