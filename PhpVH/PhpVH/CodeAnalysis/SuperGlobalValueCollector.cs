using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using Components;
using PhpVH.LexicalAnalysis;

namespace PhpVH.CodeAnalysis
{
    public class SuperGlobalValueCollector
    {
        private ExpressionWalker _walker;

        public SuperGlobalValueCollector(Token[] tokens)
        {
            _walker = new ExpressionWalker(
                tokens,
                new BooleanExpressionAnalyzer(),
                new SwitchStatementAnalyzer());
        }

        public SuperGlobalValueTable GetValues()
        {
            var table = new SuperGlobalValueTable();

            _walker.Walk();
            _walker.Analyzers.Iter(x =>
            {
                x.Matches.Iter(y =>
                {
                    var id = y.Tokens[0].Lexeme;
                    var list = table[id];

                    if (list == null)
                    {
                        list = new SuperGlobalValueList(id);
                        table.Add(list);
                    }
                    
                    Func<string, string> s = a => a.Substring(1, a.Length - 2);

                    if (x is BooleanExpressionAnalyzer)
                    {
                        list.Values.Add(
                            new SuperGlobalNameValuePair(
                                s(y.Tokens[1].Lexeme),
                                s(y.Tokens[3].Lexeme)));
                    }
                    else if (x is SwitchStatementAnalyzer)
                    {
                        list.Values.AddRange(
                            y.Tokens
                                .Skip(2)
                                .Select(z => new SuperGlobalNameValuePair(
                                    s(y.Tokens[1].Lexeme),
                                    s(z.Lexeme))));
                    }
                });
            });

            return table;
        }
    }
}
