using System.Collections.Generic;
using NUnit.Framework;
using PhpVH.LexicalAnalysis;

namespace PhpVH.Tests.Unit.LexicalAnalysis
{
    [TestFixture]
    public class LexerCommentTest
    {
        [Test, Category("PhpLexer")]
        public void PHP_Supports_C_And_C_Plus_Plus_And_Perl_Style_Comments()
        {
            TokenAssert.IsValid(new TokenPairs
            {
                { TokenType.OpenTag, "<?php" },
                { TokenType.WhiteSpace, "\n" },
                { TokenType.WhiteSpace, " " },
                { TokenType.WhiteSpace, " " },
                { TokenType.WhiteSpace, " " },
                { TokenType.WhiteSpace, " " },
                { TokenType.Identifier, "echo" },
                { TokenType.WhiteSpace, " " },
                { TokenType.String, "'This is a test'" },
                { TokenType.EndOfStatement, ";" },
                { TokenType.WhiteSpace, " " },
                { TokenType.Comment, "// This is a one-line c++ style comment" },
                { TokenType.WhiteSpace, "\n" },
                { TokenType.Comment, "/*  This is a multi line comment\n       yet another line of comment */" },
                { TokenType.WhiteSpace, "\n" },
                { TokenType.WhiteSpace, " " },
                { TokenType.WhiteSpace, " " },
                { TokenType.WhiteSpace, " " },
                { TokenType.WhiteSpace, " " },
                { TokenType.Identifier, "echo" },
                { TokenType.WhiteSpace, " " },
                { TokenType.String, "'This is yet another test'" },
                { TokenType.EndOfStatement, ";" },
                { TokenType.WhiteSpace, "\n" },
                { TokenType.WhiteSpace, " " },
                { TokenType.WhiteSpace, " " },
                { TokenType.WhiteSpace, " " },
                { TokenType.WhiteSpace, " " },
                { TokenType.Identifier, "echo" },
                { TokenType.WhiteSpace, " " },
                { TokenType.String, "'One Final Test'" },
                { TokenType.EndOfStatement, ";" },
                { TokenType.WhiteSpace, " " },
                { TokenType.Comment, "# This is a one-line shell-style comment" },
                { TokenType.WhiteSpace, "\n" },
                { TokenType.CloseTag, "?>" },
            });
        }

        [Test, Category("PhpLexer")]
        public void One_Line_Html_Php_Mixed_With_Comment_Returns_Tokens()
        {
            var lexer = new Lexer("<h1>This is an <?php # echo 'simple';?> example</h1>");
            var tokens = lexer.GetTokens();
            CollectionAssert.AreEqual(new List<Token>
            {
                new Token(TokenType.Html, "<h1>This is an ", 0),
                new Token(TokenType.OpenTag, "<?php", 15),
                new Token(TokenType.WhiteSpace, " ", 20),
                new Token(TokenType.Comment, "# echo 'simple';", 21),
                new Token(TokenType.CloseTag, "?>", 37),
                new Token(TokenType.Html, " example</h1>", 39)
            }, tokens);
        }

        [Test, Category("PhpLexer")]
        public void Toggle_Comments_Returns_Tokens()
        {
            TokenAssert.IsValid(new TokenPairs
            {
                { TokenType.OpenTag, "<?php" },
                { TokenType.WhiteSpace, "\n" },
                { TokenType.Comment, "//*" },
                { TokenType.WhiteSpace, "\n" },
                { TokenType.ifKeyword, "if" },
                { TokenType.WhiteSpace, " " },
                { TokenType.LeftParenthesis, "(" },
                { TokenType.Variable, "$foo" },
                { TokenType.RightParenthesis, ")" },
                { TokenType.WhiteSpace, " " },
                { TokenType.LeftBrace, "{" },
                { TokenType.WhiteSpace, "\n" },
                { TokenType.WhiteSpace, "\t" },
                { TokenType.Identifier, "echo" },
                { TokenType.WhiteSpace, " " },
                { TokenType.Variable, "$bar" },
                { TokenType.EndOfStatement, ";" },
                { TokenType.WhiteSpace, "\n" },
                { TokenType.RightBrace, "}" },
                { TokenType.WhiteSpace, "\n" },
                { TokenType.Comment, "// */" },
                { TokenType.WhiteSpace, "\n" },
                { TokenType.Identifier, "sort" },
                { TokenType.LeftParenthesis, "(" },
                { TokenType.Variable, "$morecode" },
                { TokenType.RightParenthesis, ")" },
                { TokenType.EndOfStatement, ";" },
                { TokenType.WhiteSpace, "\n" },
                { TokenType.CloseTag, "?>" },
                { TokenType.Html, "\n" },
                { TokenType.OpenTag, "<?php" },
                { TokenType.WhiteSpace, "\n" },
                { TokenType.Comment, "/*\nif ($foo) {\n\techo $bar;\n}\n// */" },
                { TokenType.WhiteSpace, "\n" },
                { TokenType.Identifier, "sort" },
                { TokenType.LeftParenthesis, "(" },
                { TokenType.Variable, "$morecode" },
                { TokenType.RightParenthesis, ")" },
                { TokenType.EndOfStatement, ";" },
                { TokenType.WhiteSpace, "\n" },
                { TokenType.CloseTag, "?>" },
                { TokenType.Html, "\n" },
                { TokenType.OpenTag, "<?php" },
                { TokenType.WhiteSpace, "\n" },
                { TokenType.Comment, "//*" },
                { TokenType.WhiteSpace, "\n" },
                { TokenType.ifKeyword, "if" },
                { TokenType.WhiteSpace, " " },
                { TokenType.LeftParenthesis, "(" },
                { TokenType.Variable, "$foo" },
                { TokenType.RightParenthesis, ")" },
                { TokenType.WhiteSpace, " " },
                { TokenType.LeftBrace, "{" },
                { TokenType.WhiteSpace, "\n" },
                { TokenType.WhiteSpace, " " },
                { TokenType.WhiteSpace, " " },
                { TokenType.Identifier, "echo" },
                { TokenType.WhiteSpace, " " },
                { TokenType.Variable, "$bar" },
                { TokenType.EndOfStatement, ";" },
                { TokenType.WhiteSpace, "\n" },
                { TokenType.RightBrace, "}" },
                { TokenType.WhiteSpace, "\n" },
                { TokenType.Comment, "/*/\nif ($bar) {\n\techo $foo;\n}\n// */" },
                { TokenType.WhiteSpace, "\n" },
                { TokenType.CloseTag, "?>" },
                { TokenType.Html, "\n" },
                { TokenType.OpenTag, "<?php" },
                { TokenType.WhiteSpace, "\n" },
                { TokenType.Comment, "/*\nif ($foo) {\n  echo $bar;\n}\n/*/" },
                { TokenType.WhiteSpace, "\n" },
                { TokenType.ifKeyword, "if" },
                { TokenType.WhiteSpace, " " },
                { TokenType.LeftParenthesis, "(" },
                { TokenType.Variable, "$bar" },
                { TokenType.RightParenthesis, ")" },
                { TokenType.WhiteSpace, " " },
                { TokenType.LeftBrace, "{" },
                { TokenType.WhiteSpace, "\n" },
                { TokenType.WhiteSpace, " " },
                { TokenType.WhiteSpace, " " },
                { TokenType.Identifier, "echo" },
                { TokenType.WhiteSpace, " " },
                { TokenType.Variable, "$foo" },
                { TokenType.EndOfStatement, ";" },
                { TokenType.WhiteSpace, "\n" },
                { TokenType.RightBrace, "}" },
                { TokenType.WhiteSpace, "\n" },
                { TokenType.Comment, "// */" },
                { TokenType.WhiteSpace, "\n" },
                { TokenType.CloseTag, "?>" }
            });
        }

        [Test, Category("PhpLexer")]
        public void Two_Slashes_Returns_Comment_Token()
        {
            TokenAssert.IsValid(TokenType.Comment, "//");
        }

        [Test, Category("PhpLexer")]
        public void Three_Slashes_Returns_Comment_Token()
        {
            TokenAssert.IsValid(TokenType.Comment, "///");
        }

        [Test, Category("PhpLexer")]
        public void Star_Slash_Returns_Comment_Token()
        {
            TokenAssert.IsValid(TokenType.Comment, "/* comment */");
        }

        [Test, Category("PhpLexer")]
        public void Star_Slash_No_Close_Tag_Returns_Comment_Token()
        {
            var lexer = new Lexer("<?/*");
            var tokens = lexer.GetTokens();
            CollectionAssert.AreEqual(new List<Token>
            {
                new Token(TokenType.OpenTag, "<?", 0),
                new Token(TokenType.Comment, "/*", 2)
            }, tokens);
        }

        [Test, Category("PhpLexer")]
        public void Two_Slashes_Newline_Returns_Comment_Token()
        {
            var lexer = new Lexer("<?//\nfunct");
            var tokens = lexer.GetTokens();
            CollectionAssert.AreEqual(new List<Token>
            {
                new Token(TokenType.OpenTag, "<?", 0),
                new Token(TokenType.Comment, "//", 2),
                new Token(TokenType.WhiteSpace, "\n", 4),
                new Token(TokenType.Unknown, "funct", 5)
            }, tokens);
        }

        [Test, Category("PhpLexer")]
        public void Two_Slashes_No_Close_Tag_Returns_Comment_Token()
        {
            var lexer = new Lexer("<?//");
            var tokens = lexer.GetTokens();
            CollectionAssert.AreEqual(new List<Token>
            {
                new Token(TokenType.OpenTag, "<?", 0),
                new Token(TokenType.Comment, "//", 2)
            }, tokens);
        }
    }
}
