using System;
using System.IO;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using Components;

namespace PhpVH.CodeCoverage
{
    public class CodeCoverageCalculator
    {
        private AnnotationTable _annotationTable;

        private FileInfo _annotationFile;

        public CodeCoverageCalculator(FileInfo annotationFile, AnnotationTable annotationTable)
        {
            _annotationFile = annotationFile;
            _annotationTable = annotationTable;
        }

        public CodeCoverageTable CalculateCoverage()
        {
            if (!_annotationFile.Exists)
            {
                return new CodeCoverageTable();
            }

            var entries = new List<string>();

            using (var reader = new StreamReader(_annotationFile.OpenRead()))
            {
                string entry;

                while ((entry = reader.ReadLine()) != null)
                {
                    //if (!entries.Contains(entry))
                    {
                        entries.Add(entry);
                    }
                }
            }

            var entryTable = new CodeCoverageTable();

            foreach (var entry in entries)
            {
                //try
                //{
                    var filename = entry.RemoveAtLastIndexOf('_');
                    var id = int.Parse(entry.SubstringAtLastIndexOf('_', 1));
                    _annotationTable[filename][id].HitCount++;                    
//                }
//                catch (System.Exception ex)
//                {
//#if DEBUG
//                    TraceHelper.WriteLineFormat(ex.ToString());
//#endif
//                }
            }

            var template = @"<!DOCTYPE html>

<html lang=""en"" xmlns=""http://www.w3.org/1999/xhtml"">
<head>
    <meta charset=""utf-8"" />
    <title></title>
</head>
<body>
    <style type=""text/css"">
        .covered {{
            float: left;
            background-color: green;
        }}
        .uncovered {{
            float: left;
            background-color: red;
        }}
    </style>
    {0}
</body>
</html>";

            //IndexTable
            //    .Select(x => new
            //    {
            //        Filename = x.Filename,
            //        Code = File.ReadAllText(x.Filename + "b"),
            //        Annotations = x.OrderByDescending(y => y.Index).ToArray(),
            //    })
            //    .Select(x => new
            //    {
            //        Code = string.Format(
            //            template,
            //            new StringBuilder(HttpUtility.HtmlEncode(
            //            x.Annotations
            //                .Aggregate(
            //                    new StringBuilder(x.Code),
            //                    (sb, y) => sb.Insert(
            //                        y.Index,
            //                        y.HitCount > 0 ? @"$$$covered$$$" : @"$$$uncovered$$$"))))
            //            .Replace("\r\n", "\n")
            //            .Replace('\r', '\n')
            //            .Replace("\n", "<br />")
            //            .Replace("$$$covered$$$", @"</div><div class=""covered"">")
            //            .Replace("$$$uncovered$$$", @"</div><div class=""uncovered"">")
            //            .Insert(0, @"<div class=""covered"">")
            //            .Append("</div>")
            //            .ToString()),
            //        Filename = x.Filename,
            //    })
            //    .ToArray()
            //    .Iter(x => File.WriteAllText(string.Format(@"c:\temp\{0}.txt", Path.GetFileName(x.Filename)), x.Code));


            //    .Select(x => 
            //    {
            //    });
            //.Aggregate(new StringBuilder(), (sb, x) => sb.Append(x.
            //;

            Func<Annotation, bool> wasHit = x => x.HitCount > 0;

            lock (_annotationTable)
            {
                var hitBlockCount = (decimal)_annotationTable
                    .Items
                    .SelectMany(x => x.Items.Where(wasHit))
                    .Count();

                var totalBlockCount = _annotationTable
                    .Items
                    .SelectMany(x => x.Items)
                    .Count();

                entryTable.Total = hitBlockCount / totalBlockCount * 100;

                _annotationTable
                    .Items
                    .Select(x => new
                    {
                        Filename = x.Filename,
                        HitBlockCount = x.Items.Count(wasHit),
                        TotalBlockCount = x.Items.Count,
                        Coverage = (decimal)x.Items.Count(wasHit) / x.Items.Count * 100,
                    })
                    .Iter(x => entryTable.Add(x.Filename, x.Coverage));
            }

            return entryTable;
        }
    }
}
