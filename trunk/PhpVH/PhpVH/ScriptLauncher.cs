using Components.ConsolePlus;
using Components.MicroScript.Interpreter;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace PhpVH
{
    public static class ScriptLauncher
    {
        private static Dictionary<string, MicroScriptObject> _executeCache = new Dictionary<string, MicroScriptObject>();

        private static Dictionary<MicroScriptObject, string[]> _testCaseCache = new Dictionary<MicroScriptObject, string[]>();

        public static bool IsExecuteCached(string filename)
        {
            return _executeCache.ContainsKey(filename);
        }

        public static MicroScriptObject Execute(string filename)
        {
            MicroScriptObject obj;

            if (_executeCache.TryGetValue(filename, out obj))
            {
                return obj;
            }

            var interpreter = new MicroScriptInterpreter();
            Cli.WriteLine("Executing ~Cyan~{0}~R~", filename);
            interpreter.InterpretFile(filename);            
            obj = interpreter.GetReturnValue();;
            _executeCache.Add(filename, obj);

            return obj;
        }

        public static string[] LoadTestCases(MicroScriptObject obj)
        {
            string[] testCases;

            if (_testCaseCache.TryGetValue(obj, out testCases))
            {
                return testCases;
            }

            testCases = MicroScriptObjectConverter.ToStringArray(obj);
            Cli.WriteLine("~Green~{0}~R~ test cases loaded", testCases.Length);
            return testCases;
        }

        public static string[] LoadTestCases(string filename)
        {
            return LoadTestCases(ScriptLauncher.Execute(filename));
        }
    }
}
