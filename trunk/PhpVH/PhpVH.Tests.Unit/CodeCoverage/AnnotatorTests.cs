using System;
using NUnit.Framework;
using PhpVH.CodeCoverage;
using PhpVH.LexicalAnalysis;

namespace PhpVH.Tests.Unit.CodeCoverage
{
    [TestFixture]
    public class AnnotatorTests
    {
        private Annotator annotator;

        private static readonly Func<string, Token[]> GetTokens = php => new Lexer(php).GetTokens().ToArray();

        private const string IfStatementFile = "if";

        private const string IfStatementPhp = "<?if($login=='admin'){$admin=1;}?>";

        private static readonly Token[] IfStatementTokens = GetTokens(IfStatementPhp);

        private const string SwitchStatementFile = "switch";

        private const string SwitchStatementPhp = "<?switch($login[0]){case 'a':if($login=='admin'){$admin=1;}}?>";

        private static readonly Token[] SwitchStatementTokens = GetTokens(SwitchStatementPhp);

        private const string TryCatchStatementFile = "try_catch";

        private const string TryCatchStatementPhp = "<?try{if($login=='admin'){$admin=1;}}catch(Exception $e){}?>";

        private static readonly Token[] TryCatchStatementTokens = GetTokens(TryCatchStatementPhp);

        private const string NoPhpCodeFile = "no_code";

        private const string NoPhpCodePhp = "<html></html>";

        private static readonly Token[] NoPhpCodeTokens = GetTokens(NoPhpCodePhp);

        [SetUp]
        public void Setup()
        {
            annotator = new Annotator
            {
                Config = ScanConfig.Create(new[] { "c:\\tools\\xampp\\htdocs", "test" })
            };
        }

        [Test]
        public void AnnotateCode_IfStatement_ReturnsCode()
        {
            string annotatedCode = annotator.AnnotateCode(IfStatementFile, IfStatementPhp, IfStatementTokens);

            Assert.AreEqual("<?\r\nAnnotation(\"if_1\");\r\nif($login=='admin'){\r\nAnnotation(\"if_0\");\r\n$admin=1;}?>", annotatedCode);
        }

        [Test]
        public void AnnotateCode_IfStatement_IncreasesAnnotationIndexes()
        {
            annotator.AnnotateCode(IfStatementFile, IfStatementPhp, IfStatementTokens);

            Assert.AreEqual(2, annotator.AnnotationIndexes[IfStatementFile]);
        }

        [Test]
        public void AnnotateCode_IfStatement_AddsNewAnnotationsToAnnotationTable()
        {
            annotator.AnnotateCode(IfStatementFile, IfStatementPhp, IfStatementTokens);

            CollectionAssert.AreEqual(new AnnotationList
            {
                new Annotation(0, 22, 0),
                new Annotation(1, 2, 0)
            }, annotator.AnnotationTable[IfStatementFile]);
        }

        [Test]
        public void AnnotateCode_SwitchStatement_ReturnsCode()
        {
            string annotatedCode = annotator.AnnotateCode(SwitchStatementFile, SwitchStatementPhp, SwitchStatementTokens);

            Assert.AreEqual("<?\r\nAnnotation(\"switch_1\");\r\nswitch($login[0]){case 'a':if($login=='admin'){\r\nAnnotation(\"switch_0\");\r\n$admin=1;}}?>", annotatedCode);
        }

        [Test]
        public void AnnotateCode_SwitchStatement_IncreasesAnnotationIndexes()
        {
            annotator.AnnotateCode(SwitchStatementFile, SwitchStatementPhp, SwitchStatementTokens);

            Assert.AreEqual(2, annotator.AnnotationIndexes[SwitchStatementFile]);
        }

        [Test]
        public void AnnotateCode_SwitchStatement_AddsNewAnnotationsToAnnotationTable()
        {
            annotator.AnnotateCode(SwitchStatementFile, SwitchStatementPhp, SwitchStatementTokens);

            CollectionAssert.AreEqual(new AnnotationList
            {
                new Annotation(0, 49, 0),
                new Annotation(1, 2, 0)
            }, annotator.AnnotationTable[SwitchStatementFile]);
        }

        [Test]
        public void AnnotateCode_TryCatchStatement_ReturnsCode()
        {
            string annotatedCode = annotator.AnnotateCode(TryCatchStatementFile, TryCatchStatementPhp, TryCatchStatementTokens);

            Assert.AreEqual("<?\r\nAnnotation(\"try_catch_3\");\r\ntry{\r\nAnnotation(\"try_catch_2\");\r\nif($login=='admin'){\r\nAnnotation(\"try_catch_1\");\r\n$admin=1;}}catch(Exception $e){\r\nAnnotation(\"try_catch_0\");\r\n}?>", annotatedCode);
        }

        [Test]
        public void AnnotateCode_TryCatchStatement_IncreasesAnnotationIndexes()
        {
            annotator.AnnotateCode(TryCatchStatementFile, TryCatchStatementPhp, TryCatchStatementTokens);

            Assert.AreEqual(4, annotator.AnnotationIndexes[TryCatchStatementFile]);
        }

        [Test]
        public void AnnotateCode_TryCatchStatement_AddsNewAnnotationsToAnnotationTable()
        {
            annotator.AnnotateCode(TryCatchStatementFile, TryCatchStatementPhp, TryCatchStatementTokens);

            CollectionAssert.AreEqual(new AnnotationList
            {
                new Annotation(0, 57, 0),
                new Annotation(1, 26, 0),
                new Annotation(2, 6, 0),
                new Annotation(3, 2, 0)
            }, annotator.AnnotationTable[TryCatchStatementFile]);
        }

        [Test]
        public void AnnotateCode_NoPhpCode_ReturnsCode()
        {
            string annotatedCode = annotator.AnnotateCode(NoPhpCodeFile, NoPhpCodePhp, NoPhpCodeTokens);

            Assert.AreEqual("<?php \r\nAnnotation(\"no_code_0\");\r\n ?><html></html>", annotatedCode);
        }

        [Test]
        public void AnnotateCode_NoPhpCode_IncreasesAnnotationIndexes()
        {
            annotator.AnnotateCode(NoPhpCodeFile, NoPhpCodePhp, NoPhpCodeTokens);

            Assert.AreEqual(1, annotator.AnnotationIndexes[NoPhpCodeFile]);
        }

        [Test]
        public void AnnotateCode_NoPhpCode_AddsNewAnnotationToAnnotationTable()
        {
            annotator.AnnotateCode(NoPhpCodeFile, NoPhpCodePhp, NoPhpCodeTokens);

            CollectionAssert.AreEqual(new AnnotationList
            {
                new Annotation(0, 6, 0)
            }, annotator.AnnotationTable[NoPhpCodeFile]);
        }
    }
}
